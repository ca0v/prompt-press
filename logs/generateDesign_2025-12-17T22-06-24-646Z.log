=== AI Response Log: generateDesign ===
Timestamp: 2025-12-17T22:06:24.646Z

=== System Prompt ===
You are an expert software architect. Generate a PromptPress design specification following this exact structure:

```
---
artifact: geode-amethyst
phase: design
depends-on: []
references: ["geode-amethyst.req", "faction.req", "faction.design", "fissure-cell.req", "fissure-cell.design"]
version: 1.0.0
last-updated: 2025-12-17
---

# [Title] - Design

## Overview
[High-level design approach]

## Architecture
[System components, modules, layers]

## API Contracts
[Interfaces, function signatures, data structures]

## Data Model
[Database schema, data structures, relationships]

## Algorithms & Logic
[Key algorithms, decision flows, business logic]

## Dependencies
[Third-party libraries, external services]

## Questions & Clarifications
[AI-CLARIFY: Design decisions that need input?]

## Cross-References
[Leave empty - references are documented in the metadata header above]

## AI Interaction Log
<!-- Auto-maintained by PromptPress extension -->
```

Generate a complete, detailed design specification. Be precise about architecture and APIs.

=== User Prompt ===
Generate a design specification for:

Describes the Amethyst geode as mentioned in @faction, @fissure-cell

Concept of Operations:

---
artifact: conops
phase: concept
depends-on: []
references: [faction.req.md, fissure-cell.req.md, game-board.req.md, game-state-manager.req.md, geode-pyrite.req.md, rules-engine.req.md, ui-ux.req.md]
version: 1.2.0
last-updated: 2025-12-17
---

# Concept of Operations (ConOps)

## Executive Summary
Petrified is a two-player, turn-based strategy board game implemented as a web-based application. Players compete to erode the opponent's Pyrite geode by strategically placing and moving geodes on a 5x5 grid board featuring rotatable fissures. The game emphasizes strategic depth through unique geode powers, fissure rotations affecting movement, and visual distinctions for immersive play. This ConOps outlines how the system supports gameplay in a web environment, ensuring fair, rule-compliant experiences for users.

## Business Objectives
- Provide an engaging, accessible web-based strategy game that promotes strategic thinking and competition.
- Enable easy deployment and play in standard web browsers without requiring specialized hardware or software installations.
- Deliver a complete gaming experience, from setup to win/loss determination, with real-time state management and feedback.
- Success criteria: Achieve a user satisfaction rating of 80%+ via post-game surveys, with average game completion time under 15 minutes and win rates balanced (e.g., 50/50 for skilled players) through fair geode power designs, including specific mechanics like Pyrite's movement and fissure effects.
- Value proposition: Offers a free, browser-based alternative to physical board games, combining collectible elements with dynamic strategy for casual and competitive players.

## Stakeholders
- **Players**: End-users (two per game session) who interact with the UI to place, move, and rotate elements, adhering to game rules. Responsibilities include turn-taking, strategic decision-making, and understanding geode powers (e.g., Pyrite as the erosion target).
- **Game Administrators/Developers**: Responsible for deploying and maintaining the web application, ensuring rules are enforced and UI is functional. They may handle future updates based on user feedback.
- **External Systems/Interfaces**: Web browsers (e.g., Chrome, Firefox) for rendering the UI hosted on GitHub Pages or other CDN. Data persistence will be satisfied using https://jsonbin.io/; users must paste an API key into the browser to create a shared game.

## Operational Concept
### Current State
Traditional board games require physical components, limiting accessibility and scalability. Players face challenges in setup, rule enforcement, and state tracking, leading to disputes or incomplete games. Web-based alternatives exist but often lack the tactile strategy of Petrified's rotatable fissures and unique geodes.

### Proposed Solution
The system operates as a web application where players access a responsive UI via browsers. The game board is a 5x5 grid with strata (home rows) and rotatable fissures. Players control identical factions of 5 geodes (Pyrite - yellow, erosion target with movement 1 cell in any direction; Rose Quartz - pink, enhanced capture; Calcite - white/clear, movement boosts; Amethyst - purple, blocking; Quartz - white/clear, fissure manipulation—details to be specified in faction.req.md). Turns involve placing/moving geodes, rotating fissures (which affect cell entry for certain geodes, e.g., blocking or allowing based on rotation and geode type), and capturing opponents. The rules engine validates actions, the state manager tracks changes, and the UI provides visual feedback with distinct colors and hover states. Play continues until one player's Pyrite is eroded (captured or unable to move).

### Operational Scenarios
- **Scenario 1: Game Setup and Initial Placement**: Players access the web app and select to start a new game. The board initializes with geodes in strata positions (e.g., Player 1's Pyrite in row 1, column 1) and fissures in neutral orientations. Player 1 places their first geode, rotating a fissure if desired (affecting future movement). The UI updates in real-time with visual distinctions (e.g., pyrite in yellow), and the state manager records positions. (Addresses initial user interaction and state initialization from game-state-manager.req.md and ui-ux.req.md.)
- **Scenario 2: Turn-Based Gameplay and Strategy**: During a turn, a player selects a geode (e.g., Pyrite moves 1 cell in any direction), chooses a valid move (validated by rules-engine.req.md), and optionally rotates a fissure (determining which geodes can enter/traverse based on rotation and type, e.g., blocking some while permitting others). If a capture occurs (e.g., landing on an opponent via geode power), the opponent's piece is removed. The UI highlights valid moves, provides feedback on game state, and shows fissure orientations. Play alternates until win conditions are met. (Covers turn sequencing, validation, captures, and fissure effects from rules-engine.req.md, game-board.req.md, fissure-cell.req.md, geode-pyrite.req.md, and faction.req.md.)
- **Scenario 3: Endgame and Win Determination**: As pieces are captured, the state manager checks for the erosion of Pyrite (the sole win condition). The UI displays a win/loss message, allowing players to restart or exit. (Addresses win/loss logic from rules-engine.req.md and state tracking from game-state-manager.req.md.)

## Functional Requirements Overview
The system must support geode placement/movement (with unique powers for strategy, e.g., Pyrite's directional movement), fissure rotation (impacting cell access based on geode types), turn validation, captures, and win/loss checks focused on Pyrite erosion. It requires visual representation of the board, geodes (with specified colors), and fissures, with interactive UI elements for selection and feedback.

## Non-Functional Requirements Overview
- **Performance**: Real-time updates with <2-second latency for moves in standard web browsers.
- **Security**: No sensitive data handling; basic input validation to prevent cheating.
- **Usability**: Responsive design for desktop/mobile, with accessibility features (e.g., keyboard navigation, screen reader support) and visual distinctions for geodes and fissures.
- **Scalability**: Support for single-session games; extensible to multiplayer if networked.

## Constraints and Assumptions
- **Technical Constraints**: Must run in modern web browsers (e.g., HTML5+ support); no offline mode; assumes stable internet for loading.
- **Business Constraints**: Two-player only; no monetization or user accounts initially.
- **Assumptions**: Players have basic web literacy; game rules are self-explanatory via UI tooltips; fissures' rotation effects are predefined and balanced; geode powers (including Pyrite's specifics) are fair to ensure 50/50 win rates.

## Risks and Mitigations
- **Risk 1: Rule Misinterpretation Leading to Invalid Moves**: Mitigation - Robust validation in rules-engine.req.md and UI feedback.
- **Risk 2: Browser Incompatibility Causing UI Issues**: Mitigation - Cross-browser testing and fallback CSS from ui-ux.req.md.
- **Risk 3: State Loss During Play**: Mitigation - Client-side state persistence with warnings from game-state-manager.req.md.

## Future Considerations
Potential roadmap includes multiplayer over networks (requiring new networking.req.md), AI opponents, mobile app ports, and custom faction expansions for enhanced scalability and engagement.

## Gap Analysis
See the Gap Analysis section above in this document for details on alignment with requirements.

## Recommended Updates
See the Recommended Updates section above in this document for suggestions.

## Requirements Traceability
- **faction.req.md**: Addresses geode design, powers (e.g., unique abilities for movement and capture, such as Pyrite's directional movement and erosion role), faction naming (The Crystalline Guard), and visual distinctions, supporting operational scenarios where players select and use geodes strategically (e.g., Pyrite as the key target; note: other powers need detailing for full workflows).
- **fissure-cell.req.md**: Defines fissure cell design, rotation mechanics (altering orientations to block/permit geode entry based on types), and integration with state management, enabling operational workflows for turn-based rotation and movement impacts in gameplay scenarios.
- **game-board.req.md**: Defines the board layout, mechanics (e.g., strata as home rows, fissure rows), and operational constraints (e.g., turn alternation, browser responsiveness), enabling workflows for piece placement, movement, and rotation.
- **game-state-manager.req.md**: Manages real-time state (positions, turns, fissures), ensuring operational consistency in tracking changes during play.
- **geode-pyrite.req.md**: Specifies Pyrite's movement (1 cell in any direction), capture rules as the erosion target, and visual aspects (yellow color), supporting endgame operational scenarios and win determination.
- **rules-engine.req.md**: Enforces turn sequencing, validations, win conditions (Pyrite erosion), and special rules (e.g., fissure effects, geode powers), critical for fair operational scenarios.
- **ui-ux.req.md**: Provides the interactive web interface (grid layout, geode colors, hover states, fissure visuals), facilitating user interactions in all operational scenarios with feedback and responsiveness.


Referenced artifacts (context):
Artifact: faction

Requirement (faction.req):
---
artifact: faction
phase: requirement
depends-on: []
references: []
last-updated: 2025-12-17
---

# Geodes Collection - Requirements

## Overview

This requirement specification outlines the design and implementation of a collection of 5 unique geodes, each possessing distinct special powers. The geodes are intended as collectible artifacts for use in the board game "petrified". Each geode must be visually distinct as each piece will have unique powers on the game board. The base faction consists of Pyrite, Rose Quartz, Calcite, Amethyst and Quartz and is collectively called **The Crystalline Guard**. Operationally, players control these geodes in web-based sessions, selecting and moving them strategically during turns, with Pyrite serving as the critical erosion target, under constraints like real-time validation and balanced win rates to promote user engagement.

## Functional Requirements
- FR-1: The collection shall consist of exactly 5 geodes.
- FR-2: Each geode will be able to interact with the board in a distinct way.
- FR-3: Each geode shall possess distinct special powers.
- FR-4: Each geode shall be visually distinct.
- FR-5: The geodes shall be usable as collectible artifacts in the board game "Petrified".
- FR-6: The base faction shall consist of Pyrite, Rose Quartz, Calcite, Amethyst, and Quartz.
- FR-7: The faction shall be collectively called "The Crystalline Guard".
- FR-8: Pyrite shall have the special power to move one space in any direction, with fissures applying.
- FR-9: Rose Quartz shall have the special power to move one space in any direction, with fissures not applying.
- FR-10: Calcite shall have the special power to move any number of spaces in a vertical or horizontal direction, with fissures applying.
- FR-11: Amethyst shall have the special power to move any number of spaces in a diagonal direction, with fissures applying.
- FR-12: Quartz shall have the special power to move any number of spaces in any direction, with fissures applying.
- FR-13: All factions in the game shall include a Pyrite piece, which shall be the target piece that needs to be captured to win the game.
- FR-14: The geodes shall have no additional special powers beyond the movement abilities specified in FR-8 through FR-12.
- FR-15: Players shall control the geodes in web-based game sessions.
- FR-16: Players shall select and move geodes strategically during their turns.
- FR-17: Movement of geodes shall be validated in real-time.

## Non-Functional Requirements
- NFR-1: Usability - Geode interactions shall be intuitive, with clear visual cues (e.g., glow effects for activation) and accessible controls for users with disabilities (e.g., keyboard navigation).
- NFR-2: Maintainability - Geode capabilities shall be expressed as a configuration.
- NFR-3: The game shall maintain balanced win rates to promote user engagement.

## Cross-References
None identified at this time. Potential future dependencies may include game engine specifications or lore documents.

## AI Interaction Log
<!-- Auto-maintained by PromptPress extension -->
---

Design (faction.design):
---
artifact: faction
phase: design
depends-on: ["game-state-manager.design"]
references: ["faction.req"]
last-updated: 2025-12-17
---

# Geodes Collection - Design

## Overview
This design specifies the tabletop gameplay model for the Geodes Collection used in the board game "Petrified". The collection consists of exactly five distinct geodes—Pyrite, Rose Quartz, Calcite, Amethyst, and Quartz—collectively called "The Crystalline Guard". Each geode is a game piece with unique movement rules on the board. There are no powers beyond movement.

The design focuses on movement validation, capture rules, faction composition, and turn sequencing consistent with the requirements. Configuration is used to express geode capabilities for maintainability (NFR-2), and usability is addressed through clear, visual differentiation of pieces (NFR-1). Digital engine integration is out of scope.

## Architecture
The architecture models tabletop gameplay mechanics. Key components:

- **Piece**: Represents a geode with identity, faction, and movement profile. Pieces are visually distinct (material/color) for usability.
- **MoveValidator**: Validates moves based on the piece's movement rules and board state, including fissure obstructions.
- **TurnEngine**: Manages turn order and move execution, including the option to manipulate a fissure as an alternative action on a turn (a cell cannot be manipulated if it was manipulated during the previous turn).
- **Faction**: Defines the set of five pieces for "The Crystalline Guard" and enforces inclusion of Pyrite as the capturable target piece.

All geode capabilities are expressed via configuration to satisfy maintainability (NFR-2). There is no power activation beyond movement. No combination mechanics exist.

## API Contracts
The contracts must be compatible with those defined in @game-state-manager.design.

Interfaces are presented in a language-agnostic style for a simple rules engine.

- **IPiece**:
  - `name(): string` — One of: Pyrite, Rose Quartz, Calcite, Amethyst, Quartz.
  - `movementProfile(): MovementProfile` — Describes allowed moves.
  - `isTarget(): boolean` — True for Pyrite.

- **IMoveValidator**:
  - `canMove(piece: IPiece, from: Coord, to: Coord, board: Board): boolean` — Validates a move per geode rules and board constraints.

- **ITurnEngine**:
  - `applyMove(move: Move): Board` — Applies a validated move, handling captures.
  - `applyFissureManipulation(cell: Coord, action: FissureAction): Board` — Applies fissure rotation or flip, with constraints on consecutive manipulations.
  - `isCapture(move: Move): boolean` — True if destination has an opposing piece; if that piece is Pyrite, the game is won.

- **MovementProfile** (config-driven):
  - `maxStep: number` — Maximum squares per move.
  - `directions: Direction[]` — Allowed directions: `orthogonal`, `diagonal`, `any`.
  - `pattern: string` — Optional descriptor (e.g., `two-step-any` for Quartz).

No activation powers, cooldowns, or resource systems exist.

## Data Model
Capabilities are expressed as configuration (YAML/JSON), satisfying NFR-2. Example:

```
faction: "The Crystalline Guard"
pieces:
  - name: Pyrite
    target: true
    movement:
      directions: any
      maxStep: 1
  - name: Rose Quartz
    target: false
    movement:
      directions: diagonal
      maxStep: unlimited
  - name: Calcite
    target: false
    movement:
      directions: any
      maxStep: 1
  - name: Amethyst
    target: false
    movement:
      directions: orthogonal
      maxStep: unlimited
  - name: Quartz
    target: false
    movement:
      directions: any
      maxStep: 2
```

Notes:
- "unlimited" indicates movement continues along valid direction until blocked.
- Quartz moves exactly two squares in any direction, which may be linear or non-linear (e.g., L-shaped), provided the path adheres to board constraints and fissures do not obstruct.
- Fissures are rotatable and flippable; their state affects movement validation (e.g., certain orientations may block paths).

## Algorithms & Logic
- **Movement Rules**:
  - Pyrite (FR-8, FR-13): Moves one position in any direction; Pyrite is the target piece that, when captured, wins the game.
  - Rose Quartz (FR-9): Moves diagonally, any distance until blocked.
  - Calcite (FR-10): Moves one position in any direction.
  - Amethyst (FR-11): Moves vertically and horizontally, any distance until blocked.
  - Quartz (FR-12): Moves exactly two squares in any direction in a single turn, which may be non-linear (e.g., L-shaped), provided each step adheres to board bounds, obstructions, and fissure states.

- **Move Validation**:
  - Check `directions`, `maxStep`/`pattern`, path obstruction (including fissures), board bounds, and destination occupancy.
  - A move that lands on an opposing piece captures it; capturing opposing Pyrite ends the game (FR-13).

- **Turn Sequence**:
  - Players alternate turns; each turn consists of either selecting a piece and executing one valid move or manipulating one fissure (rotation or flip), provided the cell was not manipulated in the previous turn.

- **No Additional Powers**:
  - There are no effects beyond movement (FR-14). No cooldowns, resources, or combinations.

## Dependencies
- Optional: Serialization library for loading movement configuration (e.g., YAML/JSON parser).
- Physical components: Clearly differentiated piece designs to satisfy NFR-1.

## Questions & Clarifications
The board has fissures, which are rotatable and flippable. They sit inside of the grid cells and a player may use a turn to manipulate one of them as long as that cell has not been manipulated during the previous move.

Quartz can move up to two squares in any direction.

## AI Interaction Log
<!-- Auto-maintained by PromptPress extension -->

---

Artifact: fissure-cell

Requirement (fissure-cell.req):
---
artifact: fissure-cell
phase: requirement
depends-on: []
references: ["game-board.req"]
version: 1.0.0
last-updated: 2025-12-17
---

# Fissure Cell - Requirements

## Overview
This requirement specification details the design, functionality, and behavior of "fissure" cells within the game board of "Petrified," a turn-based strategy board game. Fissure cells are special cells located in rows 2-4 of the 5x5 grid (20 cells total, with a distinct "center fissure" at row 3, column 3), as defined in @game-board.req. These cells are rotatable by players during their turns, altering their orientation to dynamically affect geode movement and interaction. Specifically, rotation determines which geodes (based on their types: Pyrite, Rose Quartz, Calcite, Amethyst, Quartz) can enter or traverse the cell, creating strategic depth by blocking or permitting access. Fissures are visually distinct from strata cells and must integrate seamlessly with the board's state management, ensuring real-time updates and rule enforcement. The goal is to enable tactical gameplay where fissure rotations influence piece mobility, contributing to the overarching objective of eroding the opponent's Pyrite geode. Operationally, fissures support turn-based interactions in a web-based environment.

## Functional Requirements
- FR-1: Fissure cells must be implemented as 20 distinct cells on the 5x5 grid (rows 2-4), each with a default neutral orientation at game start, and a special "center fissure" at row 3, column 3, which may have unique interaction rules (e.g., enhanced blocking or mandatory rotation effects) to be clarified in future geode-powers.req.md.
- FR-2: Each fissure cell must support rotation by 45-degree increments (up to 8 orientations) when selected during a player's turn, with the rotation action consuming the turn.  A fissure cannot be manipulated during two consecutive turns, thereby giving the initiating player a potential monopoly on that fissure.
- FR-3: Rotation of a fissure cell must alter movement rules for geodes attempting to enter or pass through it, such as: allowing entry for certain geode types (e.g., Quartz for fissure manipulation) while blocking others (e.g., Pyrite as a vulnerable target), based on the cell's current orientation and geode powers inferred from faction.req.md (e.g., Rose Quartz may bypass certain rotations).
- FR-4: The system must validate fissure rotations in real-time against game rules, preventing invalid rotations (e.g., during opponent's turn or after move completion) and integrating with rules-engine.req.md for enforcement.
- FR-5: Fissure cells must visually represent their rotation state through distinct icons, colors, or symbols (e.g., arrows indicating direction of openness/blockage), updating immediately upon rotation and persisting in the game state via game-state-manager.req.md.
- FR-6: Fissure cells must interact with geode movement logic, such that attempted moves into a rotated cell are denied if the geode type is incompatible (e.g., blocked entry triggers a UI error and turn forfeit for invalid attempt), promoting strategic decision-making.
- FR-7: The center fissure must have additional mechanics, such as mandatory rotation checks or amplified effects on surrounding cells, to differentiate it from standard fissures and enhance board centrality.
- FR-8: Fissure cells must reset to neutral orientation at the start of each new game session, ensuring consistent initial conditions.
- FR-9: The system must log all fissure rotations in the game state for auditing and replay purposes, including timestamp, player, and resulting orientation.
- FR-10: Fissure rotations must be undoable within the same turn if no subsequent actions have been taken, allowing players to experiment without penalty.
- FR-11: The center fissure must support a flip action that opens all pathways regardless of its current orientation, overriding standard rotation-based blocking or permitting rules.
- FR-12: The center fissure must allow manipulation by sequential play, enabling rotation or flipping on consecutive turns by different players without the restriction applied to standard fissures.
- FR-13: In the default orientation, each fissure cell must display as a "+" symbol and allow geode movement only in horizontal and vertical directions through the cell.
- FR-14: When rotated, each fissure cell must display as an "X" symbol and allow geode movement only in diagonal directions through the cell.
- FR-15: When flipped, the center fissure must display as a "*" symbol and allow geode movement in all directions (horizontal, vertical, and diagonal) through the cell.
- FR-16: When a geode is occupying a fissure cell, the orientation of that fissure cell must not affect the geode's movement or interactions.
- FR-17: Each round, a player must choose exactly one action: move a geode, turn a fissure, or flip a fissure.
- FR-18: Standard fissure cells cannot be turned or flipped in two consecutive turns by the same player, except for the center fissure which allows sequential manipulation by different players.

## Non-Functional Requirements
- NFR-1: Fissure cell rotations must process and render updates within 200 milliseconds in standard web browsers to maintain responsive gameplay, minimizing latency for real-time strategy.
- NFR-2: The visual representation of fissure orientations must be scalable and high-fidelity, supporting resolutions from 480px to 1920px width with clear differentiation between orientations, compliant with WCAG 2.1 AA for accessibility (e.g., alt-text for icons).
- NFR-3: Fissure mechanics must be secure against tampering, with client-side validation backed by server-side checks (via jsonbin.io) to prevent unauthorized rotations or state manipulation.

## Questions & Clarifications
Geodes that have special interactions with a fissure will describe those interactions.

## Cross-References
[Leave empty - references are documented in the metadata header]

## AI Interaction Log
<!-- Auto-maintained by PromptPress extension -->

Design (fissure-cell.design):
---
artifact: fissure-cell
phase: design
depends-on: []
references: ["fissure-cell.req", "game-board.req", "game-board.design"]
version: 1.0.0
last-updated: 2025-12-17
---

# Fissure Cell - Design

## Overview
The design for fissure cells in "Petrified" adopts a component-based extension of the game board's modular architecture, leveraging the existing grid renderer and state manager from game-board.design. Fissure cells are treated as specialized cell types within the 5x5 grid (rows 2-4, 20 total cells), each maintaining an orientation state (0-3 for 90-degree rotations) that dynamically influences geode movement based on inferred geode powers (e.g., blocking certain types like Pyrite while allowing others like Quartz). The design emphasizes real-time responsiveness, integration with rules-engine for validation, and visual distinctness using SVG icons with directional cues. Key principles include immutability for state updates to prevent concurrency issues, event-driven rotation handling, and accessibility-compliant rendering. Assumed mechanics: Rotations consume turn actions and are validated against game rules; the center fissure (row 3, column 3) has amplified effects (e.g., blocking adjacent cells); geode interactions are checked via external queries to geode power logic (pending full specs in faction.req.md). This design ensures strategic depth without disrupting board performance, aligning with FR-2 to FR-10 and NFR-1 to NFR-5 from fissure-cell.req.

## Architecture
Fissure cells are implemented as an extension of the board's Logic Layer, specifically augmenting the State Manager Module and integrating with the Grid Renderer and Interaction Handler. The architecture is layered for modularity:

- **Presentation Layer Extensions**:
  - **Fissure Renderer Submodule**: Extends Grid Renderer to overlay rotation-specific visuals (e.g., arrow icons for each of 4 orientations) on fissure cells. Uses SVG paths for scalability and accessibility (NFR-2 from fissure-cell.req), with ARIA labels for screen readers.

- **Logic Layer Extensions**:
  - **Fissure State Submodule**: Extends State Manager to track orientation (0-3) per fissure cell as part of BoardState. Handles rotation logic, ensuring only fissure cells in rows 2-4 are rotatable.
  - **Fissure Interaction Submodule**: Extends Interaction Handler to process rotation events (e.g., right-click or button press on fissure cells). Validates rotations against turn rules and publishes "fissureRotated" events for real-time feedback.
  - **Movement Validation Submodule**: Integrates with rules-engine to check geode entry based on orientation and geode type (e.g., query geode powers for compatibility, blocking invalid moves and triggering UI errors).

- **Data Layer Extensions**:
  - **Fissure Persistence Submodule**: Extends Persistence Module to include orientation data in serialized state, encrypted and stored via jsonbin.io (NFR-3, NFR-5).

The overall architecture remains event-driven with pub-sub for updates, ensuring fissure rotations trigger board re-renders without disrupting piece placements. For the center fissure, a special flag in state enables unique mechanics (e.g., cascading effects on neighbors). Scalability is maintained via optimized DOM updates (NFR-4).

## API Contracts
Fissure cells extend the Board class from game-board.design with new methods and data structures. All contracts are async where persistence is involved and include error handling (e.g., InvalidRotationError for out-of-turn attempts).

- **Extended Board Class Methods** (added for fissure support):
  - `rotateFissure(row: number, col: number, direction: 'clockwise' | 'counterclockwise'): Promise<boolean>` – Rotates the fissure at coordinates (validates if fissure cell, within turn). Returns true on success; throws error if invalid (e.g., non-fissure cell). Triggers state update and event.
  - `getFissureOrientation(row: number, col: number): number` – Returns orientation (0-3) or null if not a fissure.
  - `isFissureBlockedForGeode(row: number, col: number, geodeType: string): boolean` – Queries movement logic to check if the geode can enter based on orientation and powers (integrates with rules-engine).
  - `resetFissures(): void` – Sets all fissures to orientation 0 (neutral) at game start.
  - `undoFissureRotation(row: number, col: number): boolean` – Reverses last rotation if within turn; returns false if not possible.

- **Data Structures** (extensions to game-board.design):
  - `FissureState`: { orientation: number (0-3), isCenter: boolean, lastRotated: Date, playerId: string }
  - `ExtendedBoardState`: Array<Array<{ piece: PieceObject | null, fissure: FissureState | null }>> (augments BoardState with fissure data per cell).
  - `RotationEvent`: { type: 'fissureRotated', row: number, col: number, newOrientation: number, timestamp: Date }

- **Integration Hooks**:
  - Fissure submodules expose on(event, callback) for external listeners (e.g., rules-engine for validation). Compatible with game-state-manager.design for state syncing.

## Data Model
- **In-Memory Data Structures**:
  - Extended BoardState: 5x5 array where each cell object includes piece and fissure fields. Fissure field is null for non-fissure cells; otherwise, a FissureState object. Orientation is stored as an integer for efficient rotation (e.g., (orientation + 1) % 4 for clockwise).
  - Rotation log: Internal queue of RotationEvent objects for undo and auditing (FR-9).

- **Persistent Schema** (JSON extension for jsonbin.io):
  - { "grid": ExtendedBoardState, "rotationLog": Array<RotationEvent>, "metadata": { "lastUpdated": Date, "sessionId": string } }
  - Encrypted with AES-256; includes integrity hash (SHA-256) for tamper detection (NFR-3, NFR-5). Relationships: FissureState links to player via playerId for turn tracking; center fissure flagged for special logic.

- **Relationships**:
  - Fissures relate to geodes via movement checks (e.g., geode type queries FissureState.orientation). No external DB; flat-file persistence ensures scalability. For concurrent sessions, state is session-scoped.

## Algorithms & Logic
- **Rotation Logic**: On rotateFissure call → Validate (is fissure, within turn, via rules-engine) → Update orientation (modulo 4) → Log event → Publish update → Re-render. Time: O(1); includes undo check (last action in log).
- **Movement Check Algorithm**: isFissureBlockedForGeode → Retrieve orientation → Query geode power rules (assumed external; e.g., if orientation % 2 == 0, allow Quartz; block Pyrite) → Return boolean. Decision flow: Geode move attempt → Check target cell → If fissure, call this → If blocked, deny move and notify UI. Handles center fissure by amplifying (e.g., block adjacent if center rotated).
- **State Update**: Immutable: Clone ExtendedBoardState, modify fissure field, trigger re-render. Prevents race conditions.
- **Reset Logic**: At game start, iterate fissures (rows 2-4), set orientation=0. O(1) per fissure.
- **Visual Feedback**: On rotation, update SVG icon (e.g., rotate arrow by 90*orientation degrees). For accessibility, update ARIA labels dynamically.
- **Security Logic**: Client-side validation with server-side replay (via jsonbin.io) to confirm rotations against logs.

## Dependencies
- **Third-Party Libraries**: 
  - None (leverages existing SVG support in browsers; could optionally use a library like D3.js for advanced animations if needed for NFR-2).
- **External Services**: 
  - jsonbin.io for encrypted persistence of fissure states and logs (API key hard-coded as per game-board.design; integrates with game-state-manager for session data).

## Questions & Clarifications
[AI-CLARIFY: Specific geode power rules for fissure interactions (e.g., exact blocking/permission mappings per orientation and geode type) need clarification from faction.req.md or a new geode-powers.req.md to finalize movement algorithms—currently inferred as Quartz allows manipulation/bypass, Pyrite is blocked, etc. For the center fissure, confirm if "amplified effects" mean blocking adjacent cells or other mechanics, as this impacts API and logic design.]

## Cross-References
[Leave empty - references are documented in the metadata header above]

## AI Interaction Log
<!-- Auto-maintained by PromptPress extension -->

Based on these requirements:

---
artifact: geode-amethyst
phase: requirement
depends-on: []
references: ["faction.req", "fissure-cell.req"]
version: 1.0.0
last-updated: 2025-12-17
---

# Amethyst Geode - Requirements

## Overview
This requirement specification details the design, functionality, behavior, and integration of the Amethyst geode within the "Petrified" board game, a two-player, turn-based strategy game implemented as a web-based application. Amethyst is one of the five geodes in the base faction "The Crystalline Guard," serving as a collectible artifact with unique movement powers that emphasize diagonal traversal and strategic positioning. As specified in faction.req, Amethyst allows movement any number of spaces in diagonal directions, subject to fissure constraints from fissure-cell.req. Amethyst is visually distinct (purple color) and integrates with the game board's 5x5 grid, fissure rotations, and state management to support gameplay mechanics like placement, movement, and captures, ultimately contributing to the objective of eroding the opponent's Pyrite geode. This specification ensures Amethyst's powers are balanced for fair play, with real-time validation, visual feedback, and accessibility features to enhance user engagement in web-based sessions.

## Functional Requirements
- FR-1: Amethyst shall be one of the five geodes in the "The Crystalline Guard" faction, as defined in faction.req (FR-6 and FR-7).
- FR-2: Amethyst shall possess the special power to move any number of spaces in a diagonal direction (e.g., up-left, up-right, down-left, down-right), with fissures applying, as per faction.req (FR-11).
- FR-3: Movement for Amethyst shall be validated in real-time by the rules engine (rules-engine.req.md), ensuring paths are unobstructed, within board boundaries, and compliant with fissure orientations from fissure-cell.req (e.g., blocked if the fissure's current orientation ( "+" for horizontal/vertical or "X" for diagonal) prevents diagonal entry into or through the cell).
- FR-4: Amethyst shall not have any additional special powers beyond diagonal movement, as per faction.req (FR-14), and shall interact with fissures similarly to other geodes where fissures apply (e.g., unable to enter blocked cells based on rotation state).
- FR-5: Amethyst shall be visually represented as a purple piece on the game board, with distinct styling (e.g., color, shape, or icon) to differentiate it from other geodes, supporting faction.req (FR-4) and ui-ux.req.md for immersive play.
- FR-6: Amethyst shall integrate with fissure mechanics such that its diagonal movement is affected by fissure rotations: for standard fissures, diagonal movement may be permitted or blocked based on orientation (e.g., "X" allows diagonals, "+" blocks them), and for the center fissure, flipping to "*" allows all directions, as per fissure-cell.req (FR-3, FR-13, FR-14, FR-15).
- FR-7: Players shall select and move Amethyst during their turns, with the action limited to one per turn (e.g., move Amethyst or perform another action like rotating a fissure), validated for strategic depth and balance as per game-board.req.md and rules-engine.req.md.
- FR-8: Amethyst shall support capture mechanics: if an opposing geode lands on Amethyst's position via a valid move (considering its powers and fissures), Amethyst is removed from the board, contributing to the game's erosion objective focused on Pyrite.
- FR-9: Amethyst shall reset to its initial stratum position (as defined in game-board.req.md) at the start of each new game, with its state tracked by game-state-manager.req.md.
- FR-10: Amethyst's movement shall be undoable within the same turn if no subsequent actions have been taken, allowing experimental play without penalty, aligning with fissure-cell.req (FR-10) for consistency.
- FR-11: Amethyst shall provide UI feedback during selection, such as highlighting valid diagonal paths on the board, hover states indicating fissure impacts, and error messages for invalid moves, ensuring intuitive interaction per ui-ux.req.md.

## Non-Functional Requirements
- NFR-1: Performance - Amethyst movement calculations and validations shall complete within 200 milliseconds in standard web browsers to support real-time gameplay, aligning with fissure-cell.req (NFR-1).
- NFR-2: Usability - Amethyst interactions shall be intuitive, with clear visual cues (e.g., purple glow effects for activation, tooltips explaining diagonal movement and fissure effects), keyboard navigation, and screen reader support for accessibility, compliant with WCAG 2.1 AA, as per faction.req (NFR-1) and ui-ux.req.md.
- NFR-3: Security - Amethyst state and movements shall be validated client-side with server-side checks via jsonbin.io to prevent tampering, ensuring fair play without sensitive data exposure, per fissure-cell.req (NFR-3).
- NFR-4: Maintainability - Amethyst's capabilities (e.g., movement rules, visual properties) shall be configurable in code for easy updates, supporting faction.req (NFR-2).
- NFR-5: Scalability - Amethyst shall support single-session games in web browsers, with potential for future expansions (e.g., custom factions) without performance degradation.

## Questions & Clarifications
[AI-CLARIFY: Does Amethyst have any special interactions with the center fissure beyond standard diagonal movement rules, such as enhanced effects during flipping? Clarify if diagonal movement through occupied cells is allowed, and how it interacts with other geodes' powers during captures.]

## Cross-References
[Leave empty - references are documented in the metadata header]

## AI Interaction Log
<!-- Auto-maintained by PromptPress extension -->

=== AI Response ===
---
artifact: geode-amethyst
phase: design
depends-on: []
references: ["geode-amethyst.req", "faction.req", "faction.design", "fissure-cell.req", "fissure-cell.design"]
version: 1.0.0
last-updated: 2025-12-17
---

# Amethyst Geode - Design

## Overview
The design for the Amethyst geode adopts a component-based approach within the broader faction architecture from faction.design, focusing on its unique diagonal movement capability as a specialized extension of the Piece class. Amethyst is modeled as a stateless piece with movement logic integrated into the MoveValidator and TurnEngine from faction.design, ensuring real-time validation against board constraints, fissure orientations from fissure-cell.design, and capture rules. The design emphasizes modularity for maintainability (aligning with NFR-4 from geode-amethyst.req), usability through visual distinctions (purple styling and glow effects), and performance via optimized pathfinding algorithms. No additional powers exist beyond diagonal movement, with fissures applying standard blocking/permission rules (e.g., "+" orientation blocks diagonals, "X" permits them). Integration with the web-based UI ensures responsive feedback, and state persistence leverages jsonbin.io for tracking Amethyst's position without custom schemas.

## Architecture
Building on the tabletop gameplay model from faction.design, Amethyst is implemented as an instance of the Piece component, with movement logic encapsulated in a DiagonalMoveHandler submodule. The architecture layers as follows:

- **Presentation Layer**: Extends the UI renderer from faction.design to apply purple visual styling (e.g., SVG icon with diagonal patterns) and hover effects (e.g., highlighting diagonal paths). Integrates with fissure-cell.design's Fissure Renderer for combined visual updates.
- **Logic Layer**: 
  - **DiagonalMoveHandler Submodule**: Validates and computes diagonal paths, querying fissure states via isFissureBlockedForGeode from fissure-cell.design.
  - **AmethystValidator Submodule**: Extends MoveValidator to enforce diagonal-only directions and unlimited steps until obstructed, integrating with TurnEngine for turn-based execution.
- **Data Layer**: Amethyst's state is part of the ExtendedBoardState from fissure-cell.design, with no additional persistence beyond piece position and faction metadata.

This layered design ensures Amethyst's mechanics are decoupled from other geodes, promoting scalability and adherence to FR-2 and FR-3 from geode-amethyst.req.

## API Contracts
Contracts extend those in faction.design and fissure-cell.design, using language-agnostic interfaces for web-based integration. All methods are asynchronous where state persistence is involved.

- **Extended IPiece for Amethyst** (inherits from faction.design):
  - `getMovementProfile(): DiagonalMovementProfile` — Returns profile specific to Amethyst: { directions: ['diagonal'], maxStep: 'unlimited' }.
  - `canMoveTo(from: Coord, to: Coord, board: Board): Promise<boolean>` — Validates diagonal path, checking fissures via fissure-cell.design's isFissureBlockedForGeode.

- **DiagonalMoveHandler Interface**:
  - `computeDiagonalPath(from: Coord, to: Coord, board: Board): Array<Coord>` — Calculates unobstructed diagonal steps; returns empty if invalid.
  - `isPathClear(path: Array<Coord>, board: Board): boolean` — Iterates path, checking for pieces, bounds, and fissure compatibility.

- **Data Structures**:
  - `DiagonalMovementProfile`: { directions: string[], maxStep: string } (e.g., 'unlimited' for continuous movement).
  - `AmethystState`: { position: Coord, faction: 'The Crystalline Guard', visual: { color: 'purple', icon: 'diagonal-cross' } } — Extends PieceObject from faction.design.

Integration: Amethyst APIs hook into TurnEngine.applyMove, ensuring diagonal moves consume turns and trigger captures if landing on opponents.

## Data Model
Amethyst's data is embedded in the ExtendedBoardState from fissure-cell.design, with no separate schema. In-memory: Each Amethyst piece has an AmethystState object linked to its grid position. Persistent: Serialized as part of the grid array in JSON via jsonbin.io, with encryption for security (NFR-3). Relationships: Amethyst's position relates to fissures via orientation checks; no external dependencies. Configuration for movement is hard-coded in DiagonalMovementProfile for simplicity, satisfying NFR-4.

## Algorithms & Logic
- **Diagonal Movement Algorithm**: On move attempt → Compute path using computeDiagonalPath (BFS along diagonals, stopping at obstructions) → Validate with isPathClear (checks each step for empty cells, bounds, and fissure compatibility: e.g., if "+" orientation, block diagonal entry) → If valid, apply move via TurnEngine, triggering capture if destination occupied by opponent (removes Amethyst if captured).
- **Fissure Interaction Logic**: For standard fissures, if orientation is "X" (diagonal-permissive), allow entry; if "+", block. For center fissure flipped to "*", allow all directions. Decision flow: Path check → Query fissure state → Deny if blocked, notify UI with error.
- **Turn Integration**: Moves are undoable within turn (aligning with FR-10); consumes turn action, with UI highlighting diagonals on selection.
- **No Additional Powers**: Strictly adheres to FR-4; no interactions beyond movement and standard captures.

## Dependencies
- **Third-Party Libraries**: None; relies on browser-native features for rendering and logic.
- **External Services**: jsonbin.io for state persistence, integrated via game-state-manager.design.

## Questions & Clarifications
[AI-CLARIFY: Confirm if Amethyst's diagonal movement allows passing through occupied cells (e.g., for jumping or multi-step captures), and specify exact mappings for fissure orientations (e.g., which geode types are blocked/permitted beyond general rules) to refine the isPathClear algorithm. Also, clarify any special center fissure interactions for Amethyst, as per geode-amethyst.req FR-6.]

## Cross-References
[Leave empty - references are documented in the metadata header above]

## AI Interaction Log
<!-- Auto-maintained by PromptPress extension -->

=== End Log ===
